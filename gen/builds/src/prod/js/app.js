function formatDateVerbose(value){return moment(value,"DD/MM/YYYY").format("dddd D MMMM")}function formatDateShortFuture(value){return moment(value,"DD/MM/YYYY").from(moment())}function bzrup(url){return url+".html"}var kinoulinkMe=null,kinoulinkApp=angular.module("kinoulinkApp",["ngResource","ngRoute","ngSanitize","ngFileUpload","ui-notification","angular-loading-bar"]).run(["$rootScope","$location","data",function($rootScope,$location,data){var $html=angular.elementById("html"),$body=angular.elementById("body");$html.removeClass("loading"),null!==kinoulinkMe&&data.setUser(kinoulinkMe),$rootScope.$on("$routeChangeSuccess",function(ev,evData){$body.attr("class",evData.controller),$rootScope.sidebarToggled=!1,setTimeout(function(){$body.addClass("fx-delay")},100),ga("send","pageview",$location.path()),$html.removeClass("focus")}),clearInterval(window.__bz_loader)}]).config(["$routeProvider",function($routeProvider){$routeProvider.when("/about",{templateUrl:bzrup("about")}),null===kinoulinkMe?$routeProvider.when("/login",{templateUrl:bzrup("auth/login"),controller:"LoginController"}).when("/forgot-password",{templateUrl:bzrup("auth/forgot-password"),controller:"ForgotPassword"}).when("/register",{templateUrl:bzrup("auth/register"),controller:"RegisterController"}).otherwise({redirectTo:"/login"}):$routeProvider.when("/",{templateUrl:bzrup("home"),controller:"home",reloadOnSearch:!1}).when("/devices",{templateUrl:bzrup("devices"),controller:"DevicesController"}).when("/devices/:token",{templateUrl:bzrup("device"),controller:"DeviceController"}).when("/devices/:token/media/add",{templateUrl:bzrup("deviceMediaAdd"),controller:"DeviceMediaAddController"}).when("/media",{templateUrl:bzrup("media"),controller:"MediaController"}).otherwise({redirectTo:"/"})}]);!function(){var initInjector=angular.injector(["ng"]),$http=initInjector.get("$http");$http({method:"POST",url:appConfig.api+"user/me",withCredentials:!0,cache:!1,responseType:"json",timeout:2e4,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).error(function(data){null===data&&(data={data:{message:"Vérifiez votre connexion Internet!"}}),angular.elementById("body").html('<div style="margin:2em" class="alert alert-danger"><h1>Oups, kinoulink a un problème: </h1><p>'+data.data.message+"</p></div>")}).then(function(response){var apiResponse=response.data;200===apiResponse.status&&(kinoulinkMe=apiResponse.data,ga("set","&uid",kinoulinkMe.id)),angular.element(document).ready(function(){angular.bootstrap(document,["kinoulinkApp"])})})}(),angular.floatPrecision=function(number){return parseFloat(number.toFixed(3))},angular.elementById=function(id){return angular.element(document.getElementById(id))},angular.popupwindow=function(url,title,w,h){var left=screen.width/2-w/2,top=screen.height/2-h/2;return window.open(url,title,"toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+w+", height="+h+", top="+top+", left="+left)},Object.values=function(obj){var vals=[];for(var key in obj)obj.hasOwnProperty(key)&&vals.push(obj[key]);return vals},kinoulinkApp.filter("kinoulinkState",function(){return function(value){return 1===value?"Accepté":2===value?"Décliné":"En attente"}}),kinoulinkApp.filter("formatDateVerbose",function(){return function(value){return"string"==typeof value?moment(value,"DD/MM/YYYY").format("dddd D MMMM"):moment(1e3*value).format("dddd D MMMM")}}).filter("formatDateShortFuture",function(){return function(value){return moment(value,"DD/MM/YYYY").from(moment())}}).filter("moment",function(){return function(input){return moment(1e3*input).fromNow(!0)}}).filter("momentVerbose",function(){return function(input){return moment(1e3*input).fromNow()}}).filter("formatTime",function(){return function(input){return moment(1e3*input).format("H:mm")}}).filter("pluralize",function(){return function(input,text){return input+" "+text+(input>1?"s":"")}}).filter("distance",["data","geolocation",function(dataService,geolocation){return function(input){if(null===input||"undefined"==typeof input)return"";var distance=geolocation.getDistanceSimple(dataService.user.position,input);return 0>distance?(1e3*distance).toFixed(0)+" m":distance.toFixed(2)+" km"}}]).filter("distance2",function(){return function(distance){return distance.toFixed(0)<=0?(1e3*distance).toFixed(0)+" m":distance.toFixed(0)+" km"}}),kinoulinkApp.directive("bzInvitationsReceived",["data","$compile",function(dataService,$compile){function link(scope,element,attr){userID=scope.me.id,scope.$watch(attr.bzInvitationsReceived,function(value){angular.forEach(value,function(item){element.append(renderInvitation(item))}),$compile(element.contents())(scope)})}function renderInvitation(invitation){var accepted=!1,declined=!1,author=invitation.author.id===userID,html='<div class="clearfix __row">';return html+='<div class="table-cell _w-a"><a ng-href="#/u/'+invitation.author.id+'"><img src="'+invitation.author.avatar.big+'" /></a> </div>',html+='<div id="invitation-'+invitation.id+'" class="panel-form __m"><div class="row">',invitation.hasOwnProperty("workflow")&&angular.forEach(invitation.workflow,function(step){step.user===dataService.user.id&&(1==step.status?(accepted=!0,html+='<span class="ribbon _accepted"><i class="fa fa-check"></i></span>'):2==step.status&&(declined=!0,html+='<span class="ribbon _declined"><i class="fa fa-plus"></i></span>'))}),html+='<div class="col-sm-8">',html+=author?"<h4>Vous avez lancé un bilzunch</h4>":"<h4>"+invitation.author.title+" vous invite à un kinoulink</h4>",html+='<span class="__st">'+formatTimeAgo(invitation.createdat)+'</span><p><i class="fa fa-clock-o"></i> '+formatDateVerbose(invitation.date)+" ("+formatDateShortFuture(invitation.when)+") à "+invitation.time+'</p><p><i class="fa fa-map-marker"></i> '+invitation.place+"</p>",html+="<div>",1===invitation.guests.length?html+='<p><i class="fa fa-users"></i> un '+(author?"":"autre ")+"invité</p>":invitation.guests.length>0&&(html+='<p><i class="fa fa-users"></i> '+invitation.guests.length+(author?"":" autres")+" invités</p>"),html+="</div>",html+="</div>",html+='<div class="col-sm-4">',invitation.guests.forEach(function(item){html+='<span class="guest"><img src="'+item.avatar.small+'" /><br/>'+item.title+"</span>"}),html+="</div></div>",html+='<div class="_f">',declined||accepted||author||(html+='<a class="_a3 pull-right" ng-click="decline(\''+invitation.id+'\')"><i class="fa fa-times" style="color:indianred"></i> Décliner</a>',html+='<a class="_a2 pull-right" ng-click="accept(\''+invitation.id+'\')"><i class="fa fa-check" style="color:darkseagreen"></i> Accepter</a>'),html+='<a class="_a1" ng-href="#/kinoulink/'+invitation.id+'">Voir en détails</a>',html+="</div>",html+="</div></div>"}function formatDateVerbose(value){return moment(value,"DD/MM/YYYY").format("dddd D MMMM")}function formatDateShortFuture(value){return moment(1e3*value).from(moment())}function formatTimeAgo(value){return moment(1e3*value).from(moment())}var userID;return{restrict:"A",invitations:"=bz-invitations-received",link:link}}]),kinoulinkApp.directive("bzLoader",function(){return{restrict:"E",templateUrl:bzrup("directives/loader")}}),kinoulinkApp.directive("bzkinoulinkMessenger",["data",function(dataService){function link(scope,rootNode,attr){function getUser(userID){var foundUser;return angular.forEach(scope.thread.users,function(user){user.id===userID&&(foundUser=user)}),null===foundUser&&(foundUser={title:"kinoulink",avatar:appConfig.root+"images/avatar.gif"}),foundUser}function renderMessage(message){var userID=message.user,user=getUser(userID),clazz=userID===dataService.user.id?"from":"to",chatNode=angular.element(rootNode.children()[0]),agoMessage=moment(1e3*message.date).fromNow(),messageContent=parseMessage(message.message);if(isNoMessages&&(isNoMessages=!1,angular.elementById("messengerNoMessages").remove()),"kinoulink"===message.user)agoMessage!==agoCurrent&&chatNode.append('<dd class="text-center text-embossed __date"><span>'+agoMessage+"</span></dd>"),chatNode.append('<dd class="_message-notify _type-'+message.type+'">'+messageContent+"</dd>"),previousMessageItem=null;else if(agoMessage===agoCurrent&&null!==previousMessageItem&&previousMessageItem.data.user===userID){var htmlNode=document.getElementById(previousMessageItem.htmlNodeID);htmlNode.innerHTML+="<br />"+messageContent}else{var htmlNodeID="messenger-message-"+Math.floor(1e10*Math.random());agoMessage!==agoCurrent&&chatNode.append('<dd class="text-center text-embossed __date"><span>'+agoMessage+"</span></dd>"),chatNode.append('<dd class="'+clazz+'"><p id="'+htmlNodeID+'">'+messageContent+'</p><img class="avatar" src="'+user.avatar+'" /></dd>'),previousMessageItem={data:message,htmlNodeID:htmlNodeID}}agoCurrent=agoMessage,clearTimeout(timerScrollBottom),timerScrollBottom=setTimeout(function(){window.scrollTo(0,bodyNode.scrollHeight)},isInitPhase?500:50),message.hasOwnProperty("id")&&message.hasOwnProperty("unread")&&angular.isDefined(message.unread.indexOf)&&message.unread.indexOf(dataService.user.id)>=0&&scope.onMessageRead(message)}scope.submitMessage=function(){var message=scope.message,threadUID=scope.thread.id,uid=dataService.user.id.substr(0,16)+"-"+(new Date).getTime();0!==message.length&&(dataService.sendRemoteMessage("chat.message.send",{m:message,t:threadUID}),dataService.api("inbox/thread/messages/post",{message:message,thread:threadUID,uid:uid},function(response){}),renderMessage({id:uid,user:dataService.user.id,message:message,date:(new Date).getTime()/1e3}),scope.message="")},scope.onMessageRead=function(message){dataService.user.notifications.messages>0&&(dataService.user.notifications.messages--,dataService.sendMessage("bind.user")),dataService.sendRemoteMessage("chat.message.read",{i:message.id,t:scope.thread.id})},scope.$watch("thread",function(value){angular.isDefined(value)&&(scope.thread=value,0===value.messages.length?rootNode.append('<span id="messengerNoMessages" class="text-embossed">Aucun message ;-(</span>'):(value.messages.sort(function(a,b){return a.date<b.date?-1:1}),angular.forEach(value.messages,function(message){renderMessage(message)})),isInitPhase=!1)}),scope.$on("chat.message.received",function(event,incomingData){null!==scope.thread&&incomingData.t===scope.thread.id&&(renderMessage({id:incomingData.i,user:incomingData.f,message:incomingData.m,date:(new Date).getTime()/1e3}),event.preventDefault())})}function parseMessage(message){if(null===message||0===message.length)return"";var replacePatternHTTP=/(\b(https?):\/\/[-A-Z0-9+&amp;@#\/%?=~_|!:,.;]*[-A-Z0-9+&amp;@#\/%=~_|])/gi,replacePatternWWW=/(^|[^\/])(www\.[\S]+(\b|$))/gim,emoticonsMap={";-)":"happy",":-)":"happy",":p":"tongue",";(":"sad",":(":"sad",";-(":"sad",":s":"wink",":o":"confused"},emoticonsMap2=["wink","grin","cool","angry","evil","shocked","baffled","confused","neutral","sleepy","crying"],tokens=message.split(" "),newMessage="",message=htmlentities(message);return message=message.replace(replacePatternHTTP,'<a class="colored-link-1" title="$1" href="$1" target="_blank">$1</a>'),message=message.replace(replacePatternWWW,'$1<a class="colored-link-1" href="http://$2" target="_blank">$2</a>'),angular.forEach(tokens,function(token){if(emoticonsMap.hasOwnProperty(token))newMessage+='<i class="icon-'+emoticonsMap[token]+'"></i>';else if("("===token[0]&&")"===token[token.length-1]){var k=token.substring(1,token.length-1);newMessage+=emoticonsMap2.indexOf(k)>-1?'<i class="icon-'+k+'"></i>':token}else newMessage+=token;newMessage+=" "}),newMessage}var previousMessageItem=null,timerScrollBottom=0,agoCurrent=null,isInitPhase=!0,isNoMessages=!0,bodyNode=document.getElementById("body");return{restrict:"A",template:'<dl class="chat"></dl><form class="message-input" ng-submit="submitMessage()"><input name="message" type="text" ng-model="message" placeholder="Entrez votre message ici ..."><button type="submit"><i class="fa fa-chevron-right"></i></button></form>',scope:{thread:"=bzThread",onThread:"=bzOnThread",message:"@"},link:link}}]),kinoulinkApp.directive("bzPresence",["$http",function($http){function link(scope,element,attr){var user=null;scope.refresh=function(){$http({method:"GET",url:"http://messenger.kinoulink.fr/presence/"+user.id,withCredentials:!1,cache:!1,responseType:"json",timeout:2e4,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).error(function(data){}).then(function(response){var status=response.data.status;200===status?element.html('<img src="'+appConfig.root+'images/presence-online.png" />'):element.html("")})},scope.$watch(attr.bzUser,function(value){user=value,scope.refresh()})}return{restrict:"E",template:"",link:link}}]),kinoulinkApp.directive("bzRestaurantsBook",["data","geolocation",function(data,geolocation){function link($scope,element,attrs){$scope.restaurants=null,$scope.search="",$scope.$watch("search",function(value){data.api("data/search",{places:!0,users:!1,query:value},function(response){200===response.status&&($scope.restaurants=response.data.hits)})})}return{restrict:"A",templateUrl:bzrup("directives/restaurants_book"),link:link}}]),kinoulinkApp.factory("browser",["layout",function(layout){return{isIOS:function(){return/(iPad|iPhone|iPod)/g.test(navigator.userAgent)},isMobile:function(){var header=document.getElementById("header");return layout.isVisible(header)}}}]),function(angular,bz){function DataService($rootScope,$http,Notification){this.user=null,this.$rootScope=$rootScope,this.$http=$http,this.Notification=Notification,this.apiRoot=appConfig.api,this.$rootScope.messenger_connected=!1}var instance=null;DataService.prototype.sendMessage=function(name,args){return instance.$rootScope.$broadcast(name,args)},DataService.prototype.setUser=function(value){null===instance.user&&(instance.user=value),instance.user=value,instance.sendMessage("bind.user",value)},DataService.prototype.displayError=function(title,response){response.data.hasOwnProperty("error")?this.notifyDisplayToast("danger",title,response.data.error):this.notifyDisplayToast("danger",title,response.data)},DataService.prototype.api=function(service,param,callback){return null!==instance.user&&(param.user_access_token=instance.user.access_token),instance.$http({method:"POST",url:instance.apiRoot+service,data:param,withCredentials:!0,cache:!1,responseType:"json",timeout:2e4,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(response,status,headers,config){null===response?(instance.notifyDisplayToast("danger","kinoulink API","Le serveur kinoulink semble rencontrer un petit problème ;-("),response={status:500,data:null}):200==response.status?Rollbar.info("API /"+service,{query:param}):Rollbar.error("API /"+service,{query:param,response:response}),callback(response)}).error(function(response,status,headers,config){var error;null===response?(response={status:500,data:null},error="Le serveur kinoulink semble rencontrer un petit problème ;-("):error="Le serveur kinoulink semble rencontrer un petit problème: "+response.data,instance.notifyDisplayToast("danger","kinoulink API",error),callback(response)})},DataService.prototype.notifyDisplayToast=function(type,title,message){this.Notification.error({message:message,title:title,positionY:"bottom"})},DataService.prototype.notifyPlaySound=function(){instance.sendMessage("notify.sound.play")},kinoulinkApp.factory("data",["$rootScope","$http","Notification",function($rootScope,$http,Notification){return null===instance&&(instance=new DataService($rootScope,$http,Notification)),instance}])}(angular,window.bz),kinoulinkApp.factory("layout",function(){function init(){}function isMobile(){var header=document.getElementById("header");return isVisible(header)}function isVisible(el){return el.offsetWidth>0&&el.offsetHeight>0}function getWindowSize(){function isDocumentElementHeightOff(){var r,div=d.createElement("div");return div.style.height="50000px",d.body.insertBefore(div,d.body.firstChild),r=d.documentElement.clientHeight>49e3,d.body.removeChild(div),r}var docEl=document.documentElement,d=document,b=document.body,IS_BODY_ACTING_ROOT=docEl&&0===docEl.clientHeight;return"number"==typeof document.clientWidth?{width:function(){return d.clientWidth},height:function(){return d.clientHeight}}:IS_BODY_ACTING_ROOT||isDocumentElementHeightOff()?{width:function(){return b.clientWidth},height:function(){return b.clientHeight}}:{width:function(){return docEl.clientWidth},height:function(){return docEl.clientHeight}}}return{getWindowSize:getWindowSize,init:init,isVisible:isVisible,isMobile:isMobile}}),kinoulinkApp.factory("router",["$location","$routeParams",function($location,$routeParams){function redirectPath(path){return redirectInternUri("#"+path)}function redirectInternUri(uri){return redirectUrl(appConfig.phonegap?"file://"+location.pathname+uri:"/"+uri)}function redirectUrl(url){window.location.href=url}return{redirectUri:redirectUrl,redirectPath:redirectPath,reload:function(){window.location.reload()},reloadApp:function(){redirectInternUri("")},path:function(path){return $location.path(path)},get:function(name){return $routeParams[name]}}}]),kinoulinkApp.controller("DeviceController",["$scope","$rootScope","data","router",function($scope,$rootScope,dataService,router){function refresh(){dataService.api("user/devices/details",{device:device},function(response){$scope.device=response.data})}$rootScope.menu="devices";var device=router.get("token");$scope.addMedia=function(){dataService.api("user/devices/media/add",{device:device},function(response){refresh()})},$scope.detach=function(){dataService.api("user/devices/detach",{device:device},function(response){refresh()})},$scope.sendAction=function(action){dataService.api("user/devices/actions/add",{device:device,action:action},function(response){refresh()})},$scope.removeMedia=function(media){dataService.api("user/devices/media/remove",{device:device,media:media},function(response){refresh()})},refresh()}]),kinoulinkApp.controller("DeviceMediaAddController",["$scope","$rootScope","data","router",function($scope,$rootScope,dataService,router){function refresh(){dataService.api("user/media/",{device:device},function(response){$scope.medias=response.data})}$rootScope.menu="devices";var device=router.get("token");$scope.device=device,$scope.addMedia=function(media){dataService.api("user/devices/media/add",{device:device,media:media._id},function(response){router.path("/devices/"+$scope.device)})},refresh()}]),kinoulinkApp.controller("DevicesController",["$scope","$rootScope","data",function($scope,$rootScope,dataService){function refresh(){dataService.api("user/devices/",{},function(response){$scope.devices=response.data})}$rootScope.menu="devices",$scope.add=function(){dataService.api("user/devices/attach",{device:$scope.add.code},function(response){200==response.status?refresh():dataService.displayError("Nouvelle KTV",response)})},refresh()}]),kinoulinkApp.controller("ForgotPassword",["$scope","data",function($scope,dataService){var htmlNode=angular.elementById("html");htmlNode.removeClass("loading"),$scope.loading=!1}]),kinoulinkApp.controller("LoginController",["$scope","data","router",function($scope,data,router){$scope.username="",$scope.password="",$scope.connected=!1,null!==data.user&&router.reloadApp(),appConfig.phonegap&&($scope.username=window.localStorage.getItem("default_username")),$scope.doLogin=function(){var extraData={device:appConfig.device};appConfig.phonegap&&window.localStorage.setItem("default_username",$scope.username),data.api("user/auth/login",{login:$scope.username,password:$scope.password,extra:extraData},function(response){if(200==response.status){angular.elementById("loginForm");ga("send","event","auth","login","email"),router.reloadApp(),$scope.connected=!0}else data.displayError("Connexion",response)})},$scope.onInputFocus=function(){},$scope.openSite=function(){window.open(encodeURI("http://www.kinoulink.com"),"_system","location=yes")}}]),kinoulinkApp.controller("MeProfileController",["$scope","data","$upload","geolocation",function($scope,dataService,$upload,geolocation){function setUserPosition(lat,lon){$scope.user.avatar.map="https://maps.googleapis.com/maps/api/staticmap?zoom=13&size=100x100&maptype=roadmap%20&markers=color:blue%7Clabel:S%7C"+lat+","+lon,dataService.user.position={lat:lat,lon:lon},dataService.api("me/position",dataService.user.position,function(response){})}function formatCoord(value){return parseFloat(parseFloat(""+value).toFixed(3))}$scope.user=dataService.user,$scope.uploadProgress=0,$scope.pseudo_type={a:"Prénom N.",b:"Prénom Nom"},$scope.geoWorkflowStep=0,$scope.geo={city:"",address:""},$scope.loadingStatus=!1,$scope.submitStatus=function(){$scope.loadingStatus=!0,dataService.api("me/status/edit",{status:$scope.user.status.text},function(response){$scope.loadingStatus=!1,200===response.status?dataService.notifyDisplayToast("success","kinoulink","Statut enregistré !"):dataService.notifyDisplayToast("danger","kinoulink",response.data.message)})},$scope.submitDetails=function(){dataService.api("me/edit",$scope.user,function(response){200===response.status?dataService.notifyDisplayToast("success","kinoulink","Informations enregistrées !"):dataService.notifyDisplayToast("danger","kinoulink",response.data.message)})},$scope.onFileSelect=function(files){var fileToUpload=files[0];$scope.uploadProgress=0,$scope.upload=$upload.upload({url:dataService.apiRoot+"me/avatar/upload",method:"POST",cache:!1,responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"},withCredentials:!0,file:fileToUpload}).progress(function(evt){$scope.uploadProgress=parseInt(100*evt.loaded/evt.total)}).success(function(data,status,headers,config){$scope.uploadProgress=0,dataService.user.avatar.small=data.data.small,dataService.user.avatar.big=data.data.big})},$scope.submitPassword=function(){dataService.api("me/password/change",{password:$scope.password},function(response){})},$scope.$watch("user.name",function(value){var firstname=$scope.user.name.first,lastname=$scope.user.name.last;$scope.pseudo_type={a:firstname+" "+(lastname.length>0?lastname[0]+".":""),b:firstname+" "+lastname}},!0),$scope.geoSearch=function(){var myGeocoder=new google.maps.Geocoder,GeocoderOptions={address:$scope.geo.city,region:"FR"};$scope.geoWorkflowStep=2,myGeocoder.geocode(GeocoderOptions,function(results,status){if($scope.geoWorkflowStep=0,status==google.maps.GeocoderStatus.OK){var coords=results[0].geometry.location,lat=formatCoord(coords.lat()),lon=formatCoord(coords.lng());setUserPosition(lat,lon)}else dataService.notifyDisplayToast("error","Géo-localisation","Impossible de décoder cette ville ou cette adresse !");$scope.$apply()})},$scope.geoCenterOnPosition=function(){$scope.geoWorkflowStep=2,geolocation.start()},$scope.$on("geo.position",function(event,position){if($scope.geoWorkflowStep=0,geolocation.stop(),position.hasOwnProperty("coords")){var coords=position.coords,lat=formatCoord(coords.latitude),lon=formatCoord(coords.longitude);setUserPosition(lat,lon)}else dataService.notifyDisplayToast("danger","Géo-localisation","Erreur "+position)})}]),kinoulinkApp.controller("MediaController",["$scope","$rootScope","data","Upload",function($scope,$rootScope,dataService,Upload){function refresh(){dataService.api("user/media/",{},function(response){$scope.loading=!1,200==response.status?$scope.medias=response.data:dataService.displayError("Media",response)})}$scope.loading=!0,$rootScope.menu="media",$scope.onFileSelect=function(files){var fileToUpload=files[0];$scope.uploadProgress=0,$scope.upload=Upload.upload({url:dataService.apiRoot+"user/media/upload",method:"POST",cache:!1,responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded"},withCredentials:!0,file:fileToUpload}).progress(function(evt){$scope.uploadProgress=parseInt(100*evt.loaded/evt.total)}).success(function(data,status,headers,config){$scope.uploadProgress=0,200==data.status?refresh():dataService.displayError("Téléchargement",data)})},$scope.add=function(){dataService.api("user/media/upload",{device:$scope.add.code},function(response){refresh()})},refresh()}]),kinoulinkApp.controller("NotifyController",["$scope","data",function($scope,data){function playSound(){document.getElementById("audioNotif").play()}function displayToast(event,options){$scope.notif_type=options.type,$scope.notif_title=options.title,$scope.notif_message=options.message,setTimeout(function(){$scope.notif_type=null,$scope.$apply()},1e4)}document.getElementById("body");$scope.notif_title=null,$scope.notif_message=null,$scope.notif_type=null,$scope.$on("notify.sound.play",playSound),$scope.$on("notify.toast.display",displayToast)}]),kinoulinkApp.controller("RegisterController",["$scope","$location","data","router",function($scope,$location,data,router){var htmlNode=angular.elementById("html"),hasFocus=!1;$scope.user={name:{first:"",last:"",mode:"b"}},$scope.pseudo_type={b:"Prénom Nom",a:"Prénom N."},$scope.sso=null,$scope.loading=!1,htmlNode.removeClass("loading");var searchObject=$location.search();searchObject.hasOwnProperty("email")&&($scope.user.email=searchObject.email),searchObject.hasOwnProperty("firstname")&&($scope.user.name.first=searchObject.firstname),searchObject.hasOwnProperty("lastname")&&($scope.user.name.last=searchObject.lastname),$scope.doRegister=function(){var extraData={device:appConfig.device},params=angular.extend(extraData,$scope.user);$scope.loading=!0,data.api("user/auth/register",params,function(response){if($scope.loading=!1,200===response.status)if(data.setUser(response.data),ga("send","event","auth","register","Inscription",1),appConfig.phonegap)router.reloadApp();else{var form=angular.elementById("registerForm");form.removeAttr("onsubmit").removeAttr("ng-submit"),setTimeout(function(){form[0].submit()},150)}else data.notifyDisplayToast("danger","Inscription",response.data)})},$scope.onInputFocus=function(){hasFocus||(hasFocus=!0,window.scrollTo(0,150),document.body.scrollTop=150)}}]),kinoulinkApp.controller("home",["$scope","data",function($scope,dataService){}]),kinoulinkApp.controller("menu",["$scope","$window","data",function($scope,$window,dataService){$scope.logout=function(){dataService.api("/user/auth/logout",{},function(){$window.location.reload()})}}]);